{{ define "main" }}
  <section id="detail-view" class="view is-active" aria-label="Spacegroup detail view">
    <div class="detail-header panel">
      <div class="detail-meta">
        <div class="detail-meta-item">
          <p class="kicker">HM</p>
          <select
            class="detail-select"
            aria-label="Select HM symbol"
            data-selected="{{ .Params.universal_hm }}"
            onchange="if (this.value) window.location = this.value;"
          ></select>
        </div>
        <div class="detail-meta-item">
          <p class="kicker">ITA#</p>
          <select
            class="detail-select"
            aria-label="Select ITA number"
            data-selected="{{ .Params.ita_number }}"
            onchange="if (this.value) window.location = this.value;"
          ></select>
        </div>
        <div class="detail-meta-item">
          <p class="kicker">Hall</p>
          <select
            class="detail-select"
            aria-label="Select Hall symbol"
            data-selected="{{ .Params.hall_key }}"
            onchange="if (this.value) window.location = this.value;"
          ></select>
        </div>
        <div class="detail-meta-item settings-meta-item">
          <p class="kicker">Show settings</p>
          <button class="settings-toggle" type="button" data-settings-toggle aria-label="Toggle settings mode">
            <span class="settings-label settings-label-ita" aria-hidden="true">ITA</span>
            <span class="settings-toggle-track" aria-hidden="true"><span class="settings-toggle-thumb"></span></span>
            <span class="settings-label settings-label-all" aria-hidden="true">ALL</span>
          </button>
        </div>
      </div>
    </div>

    <div class="detail-grid">
      <article class="detail-card panel section-wide">
        <h3>Alternative settings</h3>
        {{ $related := .Params.related_settings }}
        {{ if $related }}
          <div class="related-links">
            {{ range $related }}
              {{ $classes := slice "related-link" }}
              {{ if .is_reference_setting }}{{ $classes = $classes | append "is-standard" }}{{ end }}
              {{ if eq $.Params.hall_key .hall_key }}{{ $classes = $classes | append "is-active" }}{{ end }}
              {{ $label := "—" }}
              {{ if .is_reference_setting }}
                {{ $label = "ITA" }}
              {{ else }}
                {{ $hm := string (default "" .universal_hm) }}
                {{ $suffix := findRE "\\([^)]*\\)\\s*$" $hm 1 }}
                {{ if gt (len $suffix) 0 }}
                  {{ $label = index $suffix 0 }}
                {{ end }}
              {{ end }}
              <a class="{{ delimit $classes " " }}" href="{{ printf "hall/%s/?settings=all" .hall_key | relURL }}">
                <span class="math-content">{{ $label }}</span>
              </a>
            {{ end }}
          </div>
        {{ else }}
          <p class="note">No related Hall settings available.</p>
        {{ end }}
      </article>

      <article class="detail-card panel section-half">
        <h3>Identity</h3>
        <div class="identity-grid">
          <div class="metric">
            <label>Hall Symbol</label>
            {{ $hallSymbol := default .Params.hall_key .Params.hall_latex }}
            <strong><span class="math-content">{{ partial "value.html" $hallSymbol }}</span></strong>
          </div>
          <div class="metric">
            <label>Short HM <span tabindex="0" class="info-dot" data-tip="Short Hermann-Mauguin symbol, a compact notation for symmetry elements.">i</span></label>
            {{ $shortHM := default .Params.short_hm_symbol .Params.short_hm_symbol_latex }}
            {{ $shortHMAliases := .Params.short_hm_symbol_aliases_latex }}
            {{ if not $shortHMAliases }}{{ $shortHMAliases = .Params.short_hm_symbol_aliases }}{{ end }}
            <strong>
              <span class="math-content">{{ partial "value.html" $shortHM }}</span>
              {{ if $shortHMAliases }}<span class="hm-aliases-inline math-content">({{ partial "value.html" $shortHMAliases }})</span>{{ end }}
            </strong>
          </div>
          <div class="metric">
            <label>Universal HM</label>
            {{ $universalHM := default .Params.universal_hm .Params.universal_hm_latex }}
            <strong><span class="math-content">{{ partial "value.html" $universalHM }}</span></strong>
          </div>
          <div class="metric">
            <label>n:c <span tabindex="0" class="info-dot" data-tip="Conventional setting label used in the source dataset.">i</span></label>
            {{ $nCAliases := .Params.n_c_aliases }}
            {{ if not $nCAliases }}{{ $nCAliases = .Params.n_c_alias }}{{ end }}
            <strong>
              {{ partial "value.html" .Params.n_c }}
              {{ if $nCAliases }}<span class="hm-aliases-inline">({{ partial "value.html" $nCAliases }})</span>{{ end }}
            </strong>
          </div>
          <div class="metric">
            <label>Point Group <span tabindex="0" class="info-dot" data-tip="Point group describing rotational/reflection symmetry without translations.">i</span></label>
            <strong>{{ partial "value.html" .Params.point_group }}</strong>
          </div>
          <div class="metric">
            <label>Laue Class <span tabindex="0" class="info-dot" data-tip="Laue class used in diffraction symmetry classification.">i</span></label>
            <strong>{{ partial "value.html" .Params.laue_class }}</strong>
          </div>
          <div class="metric">
            <label>Crystal System <span tabindex="0" class="info-dot" data-tip="Crystal family grouping by lattice constraints and symmetry type.">i</span></label>
            <strong>{{ partial "value.html" .Params.crystal_system }}</strong>
          </div>
        </div>
      </article>

      <article class="detail-card panel section-half">
        <h3>Details</h3>
        <div class="flag-row">
          {{ $flags := slice "is_centric" "is_chiral" "is_enantiomorphic" "is_reference_setting" }}
          {{ range $flags }}
            {{ $value := index $.Params . }}
            <span class="flag-pill {{ if $value }}true{{ else }}false{{ end }}">{{ replace . "_" " " }}: {{ if $value }}yes{{ else }}no{{ end }}</span>
          {{ end }}
        </div>
        <p class="note">Schoenflies: {{ partial "value.html" .Params.schoenflies }}</p>
        <p class="note">Qualifier: {{ partial "value.html" .Params.qualifier }}</p>
        <p class="note">Asymmetric unit <span tabindex="0" class="info-dot" data-tip="Asymmetric unit bounds that generate the full unit cell under symmetry operations.">i</span>: {{ partial "value.html" .Params.asym_unit }}</p>
        <p class="note">Lattice translations: {{ partial "value.html" .Params.n_ltr }}</p>
        <p class="note">Symmetry operations count: {{ partial "value.html" .Params.n_smx }}</p>
        <p class="note">Order Z: {{ partial "value.html" .Params.order_z }}</p>
      </article>

      <article class="detail-card panel section-wide">
        <div class="detail-card-head">
          <button class="section-toggle-btn" type="button" data-section-toggle="symops" aria-expanded="true" aria-label="Collapse section">▼</button>
          <h3>Symmetry Operations <span tabindex="0" class="info-dot" data-tip="Symmetry operations represented in coordinate form x,y,z with optional origin shifts.">i</span></h3>
        </div>
        <div data-section-body="symops">
          {{ $symops := .Params.symops }}
          {{ if $symops }}
            <table class="data-table">
              <thead>
                <tr>
                  <th>#</th>
                  <th>xyz</th>
                  <th>rot_type</th>
                  <th>screw/glide</th>
                </tr>
              </thead>
              <tbody>
                {{ range $index, $op := $symops }}
                  <tr>
                    <td>{{ add $index 1 }}</td>
                    <td>{{ partial "value.html" $op.xyz }}</td>
                    <td>{{ partial "value.html" $op.rot_type }}</td>
                    <td>{{ partial "value.html" $op.screw_glide }}</td>
                  </tr>
                {{ end }}
              </tbody>
            </table>
            <p class="note">Showing all {{ len $symops }} operations.</p>
          {{ else }}
            <p class="note">No symmetry operations in this entry.</p>
          {{ end }}
        </div>
      </article>

      <article class="detail-card panel section-wide">
        <div class="detail-card-head">
          <button class="section-toggle-btn" type="button" data-section-toggle="wyckoff" aria-expanded="true" aria-label="Collapse section">▼</button>
          <h3>Wyckoff Positions <span tabindex="0" class="info-dot" data-tip="Wyckoff positions grouped by multiplicity and site symmetry.">i</span></h3>
        </div>
        <div data-section-body="wyckoff">
          {{ $wyckoffItems := .Params.wyckoff_items }}
          {{ if $wyckoffItems }}
            {{ if gt (len $wyckoffItems) 0 }}
              <table class="data-table">
                <thead>
                  <tr>
                    <th>Label</th>
                    <th>Multiplicity</th>
                    <th>Site Symmetry</th>
                    <th>Full Orbit (xyz)</th>
                  </tr>
                </thead>
                <tbody>
                  {{ range $wyckoffItems }}
                    {{ $orbit := .orbit_xyz }}
                    {{ $orbitText := partial "orbit.html" $orbit }}
                    <tr>
                      <td>{{ .label }}</td>
                      <td>{{ partial "value.html" .multiplicity }}</td>
                      <td>{{ partial "value.html" .sitesym }}</td>
                      <td class="orbit-cell">{{ $orbitText }}</td>
                    </tr>
                  {{ end }}
                </tbody>
              </table>
              <p class="note">{{ len $wyckoffItems }} Wyckoff position{{ if ne (len $wyckoffItems) 1 }}s{{ end }} listed.</p>
            {{ else }}
              <p class="note">No Wyckoff labels present.</p>
            {{ end }}
          {{ else }}
            <p class="note">No Wyckoff data available.</p>
          {{ end }}
        </div>
      </article>

      <article class="detail-card panel section-wide">
        <h3>Maximal Subgroups</h3>
        {{ $maxSubs := .Params.maximal_subgroup_mappings }}
        {{ if $maxSubs }}
          <div class="mapping-box" data-mapping-box>
            <div class="mapping-tabs" role="tablist" aria-label="Maximal subgroup mappings">
              {{ range $idx, $item := $maxSubs }}
                {{ $label := default $item.hall_key $item.universal_hm_latex }}
                {{ if not $label }}{{ $label = $item.universal_hm }}{{ end }}
                {{ $tabId := printf "max-tab-%d" $idx }}
                <button
                  class="mapping-tab-btn{{ if eq $idx 0 }} is-active{{ end }}"
                  type="button"
                  role="tab"
                  id="{{ $tabId }}"
                  data-mapping-tab
                  data-target-id="{{ printf "max-panel-%d" $idx }}"
                  data-is-reference-setting="{{ if $item.is_reference_setting }}true{{ else }}false{{ end }}"
                  aria-controls="{{ printf "max-panel-%d" $idx }}"
                  aria-selected="{{ if eq $idx 0 }}true{{ else }}false{{ end }}"
                >
                  <span class="math-content">{{ $label }}</span>
                  <span class="mapping-meta">index {{ partial "value.html" $item.index }}</span>
                </button>
              {{ end }}
            </div>
            <p class="note" data-mapping-empty hidden>No ITA-reference subgroup mappings in this mode.</p>
            {{ range $idx, $item := $maxSubs }}
              <div
                class="mapping-panel"
                id="{{ printf "max-panel-%d" $idx }}"
                role="tabpanel"
                data-mapping-panel
                data-is-reference-setting="{{ if $item.is_reference_setting }}true{{ else }}false{{ end }}"
                {{ if ne $idx 0 }}hidden{{ end }}
              >
                <table class="data-table">
                  <thead>
                    <tr>
                      <th>G WP</th>
                      <th>H WP</th>
                      <th>H Orbit</th>
                      <th>Algebraic Map</th>
                    </tr>
                  </thead>
                  <tbody>
                    {{ $rows := $item.wyckoff_rows }}
                    {{ if $rows }}
                      {{ range $rows }}
                        <tr>
                          <td>{{ partial "value.html" .g_wp }}</td>
                          <td>{{ partial "value.html" .h_wp }}</td>
                          <td>{{ partial "value.html" .h_first_orbit_xyz }}</td>
                          <td>
                            {{ if and .affine_xyz (ge (len .affine_xyz) 3) }}
                              x'={{ index .affine_xyz 0 }}; y'={{ index .affine_xyz 1 }}; z'={{ index .affine_xyz 2 }}
                            {{ else }}
                              —
                            {{ end }}
                          </td>
                        </tr>
                      {{ end }}
                    {{ else }}
                      <tr><td colspan="4">No Wyckoff splitting data available.</td></tr>
                    {{ end }}
                  </tbody>
                </table>
              </div>
            {{ end }}
          </div>
        {{ else }}
          <p class="note">No subgroup mappings available.</p>
        {{ end }}
      </article>

      <article class="detail-card panel section-wide">
        <h3>Minimal Supergroups</h3>
        {{ $minSup := .Params.minimal_supergroup_mappings }}
        {{ if $minSup }}
          <div class="mapping-box" data-mapping-box>
            <div class="mapping-tabs" role="tablist" aria-label="Minimal supergroup mappings">
              {{ range $idx, $item := $minSup }}
                {{ $label := default $item.hall_key $item.universal_hm_latex }}
                {{ if not $label }}{{ $label = $item.universal_hm }}{{ end }}
                {{ $tabId := printf "min-tab-%d" $idx }}
                <button
                  class="mapping-tab-btn{{ if eq $idx 0 }} is-active{{ end }}"
                  type="button"
                  role="tab"
                  id="{{ $tabId }}"
                  data-mapping-tab
                  data-target-id="{{ printf "min-panel-%d" $idx }}"
                  data-is-reference-setting="{{ if $item.is_reference_setting }}true{{ else }}false{{ end }}"
                  aria-controls="{{ printf "min-panel-%d" $idx }}"
                  aria-selected="{{ if eq $idx 0 }}true{{ else }}false{{ end }}"
                >
                  <span class="math-content">{{ $label }}</span>
                  <span class="mapping-meta">index {{ partial "value.html" $item.index }}</span>
                </button>
              {{ end }}
            </div>
            <p class="note" data-mapping-empty hidden>No ITA-reference supergroup mappings in this mode.</p>
            {{ range $idx, $item := $minSup }}
              <div
                class="mapping-panel"
                id="{{ printf "min-panel-%d" $idx }}"
                role="tabpanel"
                data-mapping-panel
                data-is-reference-setting="{{ if $item.is_reference_setting }}true{{ else }}false{{ end }}"
                {{ if ne $idx 0 }}hidden{{ end }}
              >
                <table class="data-table">
                  <thead>
                    <tr>
                      <th>G WP</th>
                      <th>H WP</th>
                      <th>H Orbit</th>
                      <th>Algebraic Map</th>
                    </tr>
                  </thead>
                  <tbody>
                    {{ $rows := $item.wyckoff_rows }}
                    {{ if $rows }}
                      {{ range $rows }}
                        <tr>
                          <td>{{ partial "value.html" .g_wp }}</td>
                          <td>{{ partial "value.html" .h_wp }}</td>
                          <td>{{ partial "value.html" .h_first_orbit_xyz }}</td>
                          <td>
                            {{ if and .affine_xyz (ge (len .affine_xyz) 3) }}
                              x'={{ index .affine_xyz 0 }}; y'={{ index .affine_xyz 1 }}; z'={{ index .affine_xyz 2 }}
                            {{ else }}
                              —
                            {{ end }}
                          </td>
                        </tr>
                      {{ end }}
                    {{ else }}
                      <tr><td colspan="4">No Wyckoff splitting data available.</td></tr>
                    {{ end }}
                  </tbody>
                </table>
              </div>
            {{ end }}
          </div>
        {{ else }}
          <p class="note">No supergroup mappings available.</p>
        {{ end }}
      </article>
    </div>
  </section>
{{ end }}
